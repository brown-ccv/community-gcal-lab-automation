# GitHub Actions workflow for deploying to Google Cloud Run
# Three-phase design: prepare â†’ deploy â†’ teardown
# Trigger: Manual workflow dispatch with environment selection

name: ðŸš€ Deploy to Google Cloud Run

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
        default: 'staging'
      region:
        description: 'GCP region (must specify due to org policy)'
        required: true
        type: choice
        options:
          - us-east1
          - us-east4
          - us-central1
        default: 'us-east1'

env:
  SERVICE_NAME: gcal-lab-automation
  GCP_REGION: ${{ github.event.inputs.region }}
  NODE_VERSION: '18'

jobs:
  # ============================================================================
  # Phase 1: PREPARE - Validation, setup, and authentication
  # ============================================================================
  prepare:
    name: ðŸ” Prepare Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write
    outputs:
      project-id: ${{ steps.auth.outputs.project_id }}
      service-account: ${{ steps.validate.outputs.service_account }}
      
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ” Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          
      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ steps.auth.outputs.project_id }}
          
      - name: âœ… Validate configuration
        id: validate
        run: |
          echo "ðŸ” Validating GCP configuration..."
          
          # Check if project is accessible
          PROJECT_ID=$(gcloud config get-value project)
          echo "project_id=${PROJECT_ID}" >> $GITHUB_OUTPUT
          echo "âœ… Project ID: ${PROJECT_ID}"
          
          # Verify service account exists
          SA_EMAIL="${{ env.SERVICE_NAME }}-sa@${PROJECT_ID}.iam.gserviceaccount.com"
          if gcloud iam service-accounts describe "${SA_EMAIL}" &>/dev/null; then
            echo "âœ… Service account exists: ${SA_EMAIL}"
            echo "service_account=${SA_EMAIL}" >> $GITHUB_OUTPUT
          else
            echo "âŒ Service account not found: ${SA_EMAIL}"
            echo "ðŸ’¡ Run .deployment/scripts/gcp/setup-service-account.sh first"
            exit 1
          fi
          
          # Check required APIs
          echo "ðŸ” Checking required APIs..."
          REQUIRED_APIS=("run.googleapis.com" "cloudbuild.googleapis.com" "artifactregistry.googleapis.com")
          for API in "${REQUIRED_APIS[@]}"; do
            if gcloud services list --enabled --filter="name:${API}" --format="value(name)" | grep -q "${API}"; then
              echo "âœ… API enabled: ${API}"
            else
              echo "âš ï¸  API not enabled: ${API}"
              echo "ðŸ”„ Enabling ${API}..."
              gcloud services enable "${API}"
            fi
          done
          
          echo "âœ… All validations passed!"
          
      - name: ðŸ” Check secrets configuration
        run: |
          echo "ðŸ” Validating secrets setup..."
          
          # These secrets should exist in GCP Secret Manager
          PROJECT_ID=$(gcloud config get-value project)
          
          SECRETS=("auth-client-id" "auth-client-secret" "session-secret" "reminder-calendar-id" "retention-calendar-id")
          
          for SECRET in "${SECRETS[@]}"; do
            if gcloud secrets describe "${SECRET}" --project="${PROJECT_ID}" &>/dev/null; then
              echo "âœ… Secret exists: ${SECRET}"
            else
              echo "âš ï¸  Secret not found: ${SECRET}"
            fi
          done
          
          echo "ðŸ’¡ If secrets are missing, run .deployment/scripts/gcp/setup-gcp-secrets.sh"

  # ============================================================================
  # Phase 2: DEPLOY - Build, push, and deploy to Cloud Run
  # ============================================================================
  deploy:
    name: ðŸš€ Deploy Application
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 30
    permissions:
      contents: read
      id-token: write
    environment:
      name: ${{ github.event.inputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
      
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ” Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          
      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ needs.prepare.outputs.project-id }}
          
      - name: ðŸ”§ Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
          
      - name: ðŸ“¦ Create Artifact Registry if needed
        run: |
          REPO_NAME="cloud-run-source-deploy"
          PROJECT_ID="${{ needs.prepare.outputs.project-id }}"
          
          if gcloud artifacts repositories describe "${REPO_NAME}" \
            --location="${{ env.GCP_REGION }}" \
            --project="${PROJECT_ID}" &>/dev/null; then
            echo "âœ… Artifact Registry already exists"
          else
            echo "ðŸ”„ Creating Artifact Registry..."
            gcloud artifacts repositories create "${REPO_NAME}" \
              --repository-format=docker \
              --location="${{ env.GCP_REGION }}" \
              --description="Docker repository for Cloud Run deployments" \
              --project="${PROJECT_ID}"
            echo "âœ… Artifact Registry created"
          fi
          
      - name: ðŸ³ Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .deployment/Dockerfile
          push: true
          tags: |
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ needs.prepare.outputs.project-id }}/cloud-run-source-deploy/${{ env.SERVICE_NAME }}:${{ github.sha }}
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ needs.prepare.outputs.project-id }}/cloud-run-source-deploy/${{ env.SERVICE_NAME }}:latest
          
      - name: ðŸš€ Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.GCP_REGION }}
          image: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ needs.prepare.outputs.project-id }}/cloud-run-source-deploy/${{ env.SERVICE_NAME }}:${{ github.sha }}
          flags: |
            --service-account=${{ needs.prepare.outputs.service-account }}
            --allow-unauthenticated
            --port=8080
            --cpu=1
            --memory=512Mi
            --timeout=300
            --min-instances=0
            --max-instances=10
          env_vars: |
            NODE_ENV=production
            DEMO_MODE=false
            BYPASS_AUTH=false
            ALLOWED_DOMAIN=brown.edu
          secrets: |
            AUTH_CLIENT_ID=auth-client-id:latest
            AUTH_CLIENT_SECRET=auth-client-secret:latest
            SESSION_SECRET=session-secret:latest
            REMINDER_CALENDAR_ID=reminder-calendar-id:latest
            RETENTION_CALENDAR_ID=retention-calendar-id:latest
          
      - name: ðŸ¥ Health check
        if: success()
        run: |
          SERVICE_URL="${{ steps.deploy.outputs.url }}"
          echo "ðŸ¥ Checking service health..."
          
          # Wait for service to be ready
          sleep 10
          
          # Try health check with retries
          MAX_RETRIES=5
          RETRY=0
          
          while [ $RETRY -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/health" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check passed (HTTP ${HTTP_CODE})"
              exit 0
            fi
            
            RETRY=$((RETRY+1))
            echo "âš ï¸  Health check failed (HTTP ${HTTP_CODE}), retry ${RETRY}/${MAX_RETRIES}..."
            sleep 5
          done
          
          echo "âŒ Health check failed after ${MAX_RETRIES} retries"
          exit 1
          
      - name: ðŸ“Š Deployment summary
        if: always()
        run: |
          echo "## ðŸ“Š Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service:** ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ env.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ env.GCP_REGION }}-docker.pkg.dev/${{ needs.prepare.outputs.project-id }}/cloud-run-source-deploy/${{ env.SERVICE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Phase 3: TEARDOWN - Cleanup and rollback on failure
  # ============================================================================
  teardown:
    name: ðŸ§¹ Teardown
    runs-on: ubuntu-latest
    needs: [prepare, deploy]
    if: always() && failure()
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          
      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ needs.prepare.outputs.project-id }}
          
      - name: ðŸ”„ Rollback on failure
        if: failure()
        run: |
          echo "âš ï¸  Deployment failed, checking if rollback is needed..."
          
          PROJECT_ID="${{ needs.prepare.outputs.project-id }}"
          
          # Get current revision
          CURRENT_REVISION=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region="${{ env.GCP_REGION }}" \
            --project="${PROJECT_ID}" \
            --format="value(status.latestReadyRevisionName)" 2>/dev/null || echo "")
          
          if [ -z "$CURRENT_REVISION" ]; then
            echo "â„¹ï¸  No previous deployment found, nothing to roll back"
            exit 0
          fi
          
          # Get previous revision
          PREVIOUS_REVISION=$(gcloud run revisions list \
            --service=${{ env.SERVICE_NAME }} \
            --region="${{ env.GCP_REGION }}" \
            --project="${PROJECT_ID}" \
            --format="value(name)" \
            --sort-by="~creationTimestamp" \
            --limit=2 | tail -n 1)
          
          if [ -n "$PREVIOUS_REVISION" ] && [ "$PREVIOUS_REVISION" != "$CURRENT_REVISION" ]; then
            echo "ðŸ”„ Rolling back to previous revision: ${PREVIOUS_REVISION}"
            gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
              --region="${{ env.GCP_REGION }}" \
              --project="${PROJECT_ID}" \
              --to-revisions="${PREVIOUS_REVISION}=100"
            echo "âœ… Rollback completed"
          else
            echo "â„¹ï¸  No previous revision available for rollback"
          fi
          
      - name: ðŸ“ Post failure notification
        if: failure()
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment to ${{ github.event.inputs.environment }} failed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the deployment logs artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify all secrets are configured in GCP Secret Manager" >> $GITHUB_STEP_SUMMARY
          echo "3. Ensure service account has required permissions" >> $GITHUB_STEP_SUMMARY
          echo "4. Check Cloud Run logs: \`gcloud run logs read --service=${{ env.SERVICE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
